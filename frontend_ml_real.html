<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot - Machine Learning REAL</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d42 50%, #3e3e56 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* CONFIGURA√á√ÉO ML PANEL */
        .ml-config-panel {
            background: rgba(138, 43, 226, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(138, 43, 226, 0.4);
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.3);
        }

        .ml-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ml-api-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .ml-api-status.connected {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .ml-api-status.disconnected {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .ml-api-status.connecting {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa726;
            border: 1px solid #ffa726;
        }

        .ml-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .ml-config-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .ml-config-item h4 {
            color: #8a2be2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ml-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .ml-input:focus {
            outline: none;
            border-color: #8a2be2;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.3);
        }

        .ml-real-stats {
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff88;
        }

        .ml-prediction-display {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00d4ff;
            display: none;
        }

        .ml-prediction-display.show {
            display: block;
        }

        /* INDICADORES ML REAL */
        .ml-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .ml-indicator {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .ml-indicator-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8a2be2;
            margin-bottom: 5px;
        }

        .ml-indicator-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* Estilo base mantido do c√≥digo original mas com foco no ML */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .login-form h2 {
            color: #8a2be2;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #8a2be2, #da70d6);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(138, 43, 226, 0.3);
        }

        .dashboard-container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #8a2be2, #da70d6, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: #00ff88; }
        .status-dot.offline { background: #ff4757; }
        .status-dot.warning { background: #ffa726; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .ml-btn {
            padding: 10px 16px;
            background: linear-gradient(45deg, #8a2be2, #da70d6);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 5px;
        }

        .ml-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }

        .ml-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ml-btn.active {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
        }

        .trade-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            margin: 5px;
        }

        .trade-btn.call {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
        }

        .trade-btn.put {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: #fff;
        }

        .trade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .trade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            padding: 15px 20px;
            border-left: 4px solid #8a2be2;
            color: #fff;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { border-left-color: #00ff88; }
        .notification.error { border-left-color: #ff4757; }
        .notification.warning { border-left-color: #ffa726; }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #8a2be2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-item label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-item input, .control-item select {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .trade-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .ml-config-grid, .control-grid {
                grid-template-columns: 1fr;
            }
            
            .trade-buttons {
                flex-direction: column;
            }
            
            .ml-indicators {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Login -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>üß† Trading Bot - Machine Learning REAL</h2>
            
            <!-- Configura√ß√£o da API ML -->
            <div class="form-group">
                <label for="mlApiUrl">URL da API ML:</label>
                <input type="url" id="mlApiUrl" value="https://your-ml-api.onrender.com" 
                       placeholder="https://your-ml-api.onrender.com" required>
                <small style="color: #8a2be2;">üì° Coloque aqui a URL do seu backend ML hospedado na Render</small>
            </div>
            
            <div class="form-group">
                <label for="apiToken">Token da API Deriv:</label>
                <input type="password" id="apiToken" placeholder="Digite seu token de API da Deriv" required>
            </div>
            
            <select id="accountType" style="display: none;">
                <option value="demo" selected>Demo Account</option>
            </select>
            
            <button class="login-btn" id="loginBtn" onclick="connectSystems()">
                <span id="loginBtnText">üöÄ Conectar Deriv + ML Real</span>
                <div class="loading-spinner" id="loginSpinner" style="display: none; width: 20px; height: 20px; margin: 0 auto;"></div>
            </button>
            
            <div id="loginMessage"></div>
            
            <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.7;">
                <p>‚ÑπÔ∏è Para usar o ML Real:</p>
                <p>1. Fa√ßa deploy do backend Python na Render</p>
                <p>2. Configure a URL da API ML acima</p>
                <p>3. Obtenha seu token Deriv em <a href="https://app.deriv.com/account/api-token" target="_blank" style="color: #8a2be2;">app.deriv.com/account/api-token</a></p>
                <p style="margin-top: 10px; color: #8a2be2;">üß† Machine Learning Real com Scikit-learn + FastAPI!</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div class="dashboard-container" id="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>üß† Trading Bot - Machine Learning REAL</h1>
            <p>Conta: <span id="accountInfo">Carregando...</span></p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot offline" id="derivStatus"></div>
                    <span>Deriv API</span>
                </div>
                <div class="status-item">
                    <div class="status-dot offline" id="mlApiStatus"></div>
                    <span>ML API</span>
                </div>
                <div class="status-item">
                    <div class="status-dot offline" id="mlModelStatus"></div>
                    <span>ML Models</span>
                </div>
                <div class="status-item">
                    <div class="status-dot offline" id="tradingStatus"></div>
                    <span>Trading</span>
                </div>
            </div>
        </div>

        <!-- PAINEL DE CONFIGURA√á√ÉO ML REAL -->
        <div class="ml-config-panel">
            <div class="ml-config-header">
                <h3 style="color: #8a2be2;">üß† Sistema Machine Learning REAL</h3>
                <div class="ml-api-status disconnected" id="mlApiStatusDisplay">Desconectado</div>
            </div>

            <div class="ml-config-grid">
                <div class="ml-config-item">
                    <h4>üîó Conex√£o API</h4>
                    <input type="url" class="ml-input" id="mlApiUrlConfig" placeholder="URL da API ML">
                    <button class="ml-btn" onclick="testMLConnection()">üß™ Testar Conex√£o</button>
                    <button class="ml-btn" onclick="connectMLAPI()">üîå Conectar</button>
                    <div id="mlConnectionStatus" style="margin-top: 10px; font-size: 0.8rem;"></div>
                </div>

                <div class="ml-config-item">
                    <h4>üìä Status dos Modelos</h4>
                    <div id="mlModelsInfo">
                        <div>Modelos carregados: <span id="modelsCount">0</span></div>
                        <div>Dados de treino: <span id="trainingDataCount">0</span></div>
                        <div>√öltima atualiza√ß√£o: <span id="lastModelUpdate">Nunca</span></div>
                    </div>
                </div>

                <div class="ml-config-item">
                    <h4>‚öôÔ∏è Controles ML</h4>
                    <button class="ml-btn" onclick="forceMLTraining()" id="trainModelsBtn" disabled>
                        üéì Treinar Modelos
                    </button>
                    <button class="ml-btn" onclick="getMLStats()" id="mlStatsBtn" disabled>
                        üìà Ver Estat√≠sticas
                    </button>
                    <button class="ml-btn" onclick="analyzeMLPatterns()" id="analyzePatternsBtn" disabled>
                        üîç Analisar Padr√µes
                    </button>
                </div>
            </div>

            <!-- Indicadores ML Real -->
            <div class="ml-indicators">
                <div class="ml-indicator">
                    <div class="ml-indicator-value" id="mlAccuracyDisplay">0%</div>
                    <div class="ml-indicator-label">Precis√£o ML</div>
                </div>
                <div class="ml-indicator">
                    <div class="ml-indicator-value" id="mlPredictionsCount">0</div>
                    <div class="ml-indicator-label">Predi√ß√µes</div>
                </div>
                <div class="ml-indicator">
                    <div class="ml-indicator-value" id="mlPatternsCount">0</div>
                    <div class="ml-indicator-label">Padr√µes</div>
                </div>
                <div class="ml-indicator">
                    <div class="ml-indicator-value" id="mlTradesCount">0</div>
                    <div class="ml-indicator-label">Trades ML</div>
                </div>
            </div>

            <!-- Display de Predi√ß√µes ML -->
            <div class="ml-prediction-display" id="mlPredictionDisplay">
                <h4 style="color: #00d4ff; margin-bottom: 10px;">üéØ √öltima Predi√ß√£o ML</h4>
                <div id="mlPredictionContent">Aguardando predi√ß√£o...</div>
            </div>

            <!-- Stats ML Real -->
            <div class="ml-real-stats" id="mlRealStats" style="display: none;">
                <h4 style="color: #00ff88; margin-bottom: 10px;">üìä Estat√≠sticas ML Real</h4>
                <div id="mlRealStatsContent">Carregando...</div>
            </div>
        </div>

        <!-- Painel de Controle de Trading -->
        <div class="control-panel">
            <h3 style="color: #00d4ff; margin-bottom: 20px;">‚ö° Trading com ML Real</h3>
            
            <div class="control-grid">
                <div class="control-item">
                    <label>S√≠mbolo:</label>
                    <select id="symbolSelect">
                        <option value="R_50" selected>Volatility 50 Index</option>
                        <option value="R_75">Volatility 75 Index</option>
                        <option value="R_100">Volatility 100 Index</option>
                        <option value="R_25">Volatility 25 Index</option>
                        <option value="R_10">Volatility 10 Index</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>Valor da Aposta (USD):</label>
                    <input type="number" id="stakeAmount" value="1" min="0.35" max="50" step="0.01">
                </div>
                
                <div class="control-item">
                    <label>Dura√ß√£o:</label>
                    <select id="duration">
                        <option value="5">5 ticks</option>
                        <option value="7">7 ticks</option>
                        <option value="10">10 ticks</option>
                    </select>
                </div>

                <div class="control-item">
                    <label>Modo Trading:</label>
                    <select id="tradingMode">
                        <option value="manual">Manual</option>
                        <option value="ml_assisted">ML Assistido</option>
                        <option value="full_ml">ML Autom√°tico</option>
                    </select>
                </div>
            </div>
            
            <div class="trade-buttons">
                <button class="trade-btn call" onclick="requestMLPrediction('CALL')" id="callBtn" disabled>
                    üìà CALL (ML)
                </button>
                <button class="trade-btn put" onclick="requestMLPrediction('PUT')" id="putBtn" disabled>
                    üìâ PUT (ML)
                </button>
                <button class="trade-btn" onclick="getMLAnalysis()" id="analyzeBtn" disabled style="background: linear-gradient(45deg, #8a2be2, #da70d6);">
                    üß† An√°lise ML
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notification" id="notification"></div>

    <script>
        // ==============================================
        // CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS
        // ==============================================
        
        const CONFIG = {
            DERIV_WS_URL: 'wss://ws.derivws.com/websockets/v3?app_id=1089',
            ML_API_URL: '', // Ser√° definido pelo usu√°rio
            MIN_STAKE: 0.35,
            MAX_STAKE: 50,
            DEFAULT_SYMBOL: 'R_50'
        };

        // Estado da aplica√ß√£o
        let derivWS = null;
        let apiToken = '';
        let accountInfo = {};
        let isDerivConnected = false;
        let isMLConnected = false;
        let mlModelsLoaded = false;
        let currentPrice = 0;
        let trades = [];
        let mlStats = {};
        let lastMLPrediction = null;

        // ==============================================
        // FUN√á√ïES DE CONEX√ÉO
        // ==============================================

        async function connectSystems() {
            const token = document.getElementById('apiToken').value.trim();
            const mlApiUrl = document.getElementById('mlApiUrl').value.trim();
            
            if (!token) {
                showNotification('Por favor, insira seu token de API Deriv', 'error');
                return;
            }
            
            if (!mlApiUrl) {
                showNotification('Por favor, insira a URL da API ML', 'error');
                return;
            }

            setLoginLoading(true);
            CONFIG.ML_API_URL = mlApiUrl;
            document.getElementById('mlApiUrlConfig').value = mlApiUrl;

            try {
                // 1. Conectar √† API ML primeiro
                const mlConnected = await connectMLAPI();
                if (!mlConnected) {
                    throw new Error('Falha na conex√£o com a API ML');
                }

                // 2. Conectar ao Deriv
                await connectDeriv(token);
                
                showDashboard();
                showNotification('üöÄ Sistemas conectados: Deriv + ML Real!', 'success');
                
            } catch (error) {
                console.error('Erro na conex√£o:', error);
                showNotification(`Erro: ${error.message}`, 'error');
            } finally {
                setLoginLoading(false);
            }
        }

        async function connectMLAPI() {
            try {
                updateStatus('mlApiStatus', 'warning');
                document.getElementById('mlApiStatusDisplay').textContent = 'Conectando...';
                document.getElementById('mlApiStatusDisplay').className = 'ml-api-status connecting';
                
                console.log('üîå Conectando √† API ML:', CONFIG.ML_API_URL);
                
                // Testar conex√£o
                const response = await fetch(`${CONFIG.ML_API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const healthData = await response.json();
                console.log('‚úÖ API ML conectada:', healthData);

                isMLConnected = true;
                mlModelsLoaded = healthData.models_loaded > 0;
                
                updateStatus('mlApiStatus', 'online');
                updateStatus('mlModelStatus', mlModelsLoaded ? 'online' : 'warning');
                
                document.getElementById('mlApiStatusDisplay').textContent = 'Conectado';
                document.getElementById('mlApiStatusDisplay').className = 'ml-api-status connected';
                
                // Atualizar informa√ß√µes dos modelos
                document.getElementById('modelsCount').textContent = healthData.models_loaded;
                document.getElementById('trainingDataCount').textContent = healthData.ml_stats?.total_trades || 0;
                document.getElementById('lastModelUpdate').textContent = new Date().toLocaleString();
                
                // Habilitar controles ML
                enableMLControls(true);
                
                // Carregar estat√≠sticas iniciais
                await loadMLStats();
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro na conex√£o ML:', error);
                
                isMLConnected = false;
                mlModelsLoaded = false;
                
                updateStatus('mlApiStatus', 'offline');
                updateStatus('mlModelStatus', 'offline');
                
                document.getElementById('mlApiStatusDisplay').textContent = 'Erro: ' + error.message;
                document.getElementById('mlApiStatusDisplay').className = 'ml-api-status disconnected';
                
                enableMLControls(false);
                
                return false;
            }
        }

        async function connectDeriv(token) {
            return new Promise((resolve, reject) => {
                apiToken = token;
                derivWS = new WebSocket(CONFIG.DERIV_WS_URL);

                derivWS.onopen = function() {
                    console.log('‚úÖ WebSocket Deriv conectado');
                    updateStatus('derivStatus', 'online');
                    
                    derivWS.send(JSON.stringify({
                        authorize: token
                    }));
                };

                derivWS.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleDerivMessage(data, resolve, reject);
                    } catch (error) {
                        console.error('‚ùå Erro ao processar mensagem Deriv:', error);
                    }
                };

                derivWS.onclose = function() {
                    console.log('‚ùå WebSocket Deriv desconectado');
                    updateStatus('derivStatus', 'offline');
                    isDerivConnected = false;
                };

                derivWS.onerror = function(error) {
                    console.error('‚ùå Erro WebSocket Deriv:', error);
                    reject(new Error('Erro de conex√£o Deriv'));
                };
            });
        }

        function handleDerivMessage(data, resolve, reject) {
            console.log('üì® Mensagem Deriv:', data.msg_type, data);

            switch (data.msg_type) {
                case 'authorize':
                    if (data.authorize && data.authorize.loginid) {
                        console.log('‚úÖ Autoriza√ß√£o Deriv bem-sucedida');
                        isDerivConnected = true;
                        accountInfo = data.authorize;
                        
                        document.getElementById('accountInfo').textContent = 
                            `${data.authorize.loginid} - ${data.authorize.currency} (DEMO + ML Real)`;
                        
                        resolve(true);
                    } else {
                        reject(new Error('Token Deriv inv√°lido'));
                    }
                    break;
                    
                case 'tick':
                    if (data.tick) {
                        currentPrice = parseFloat(data.tick.quote);
                        console.log(`üìä Tick: ${data.tick.symbol} = ${currentPrice.toFixed(4)}`);
                    }
                    break;
                    
                case 'buy':
                    handleTradeCreated(data);
                    break;
                    
                default:
                    if (data.error) {
                        console.error('‚ùå Erro Deriv:', data.error);
                        showNotification(`Erro Deriv: ${data.error.message}`, 'error');
                    }
            }
        }

        async function handleTradeCreated(buyData) {
            console.log('‚úÖ Trade criado:', buyData);
            
            if (buyData.buy && buyData.buy.contract_id) {
                const tradeData = {
                    id: buyData.buy.contract_id,
                    timestamp: new Date().toISOString(),
                    symbol: document.getElementById('symbolSelect').value,
                    direction: lastMLPrediction?.direction || 'CALL',
                    stake: parseFloat(document.getElementById('stakeAmount').value),
                    duration: document.getElementById('duration').value + 't',
                    entry_price: currentPrice,
                    exit_price: null,
                    outcome: null,
                    market_context: {
                        current_price: currentPrice,
                        volatility: Math.random() * 100, // Placeholder
                        recent_results: trades.slice(-5).map(t => t.outcome).filter(o => o)
                    },
                    martingale_level: 0,
                    volatility: Math.random() * 100,
                    trend: 'neutral'
                };
                
                trades.push(tradeData);
                
                // Enviar dados para a API ML para aprendizagem
                await sendTradeToML(tradeData);
                
                showNotification(`‚úÖ Trade executado com ML: ${tradeData.direction}`, 'success');
            }
        }

        // ==============================================
        // FUN√á√ïES ML REAL
        // ==============================================

        async function sendTradeToML(tradeData) {
            if (!isMLConnected) {
                console.log('‚ö†Ô∏è ML n√£o conectado, dados do trade n√£o enviados');
                return;
            }

            try {
                console.log('üì§ Enviando trade para ML:', tradeData);
                
                const response = await fetch(`${CONFIG.ML_API_URL}/trade/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tradeData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Trade salvo no ML:', result);
                } else {
                    console.error('‚ùå Erro ao salvar trade no ML:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar trade para ML:', error);
            }
        }

        async function requestMLPrediction(direction) {
            if (!isMLConnected) {
                showNotification('ML n√£o conectado', 'error');
                return;
            }

            if (!isDerivConnected) {
                showNotification('Deriv n√£o conectado', 'error');
                return;
            }

            try {
                console.log('üß† Solicitando predi√ß√£o ML para:', direction);
                
                const requestData = {
                    symbol: document.getElementById('symbolSelect').value,
                    current_price: currentPrice,
                    direction: direction,
                    stake: parseFloat(document.getElementById('stakeAmount').value),
                    duration: document.getElementById('duration').value,
                    trend: 'neutral',
                    volatility: Math.random() * 100,
                    martingale_level: 0,
                    recent_wins: trades.filter(t => t.outcome === 'won').length,
                    recent_losses: trades.filter(t => t.outcome === 'lost').length,
                    recent_win_rate: trades.length > 0 ? trades.filter(t => t.outcome === 'won').length / trades.length : 0.5
                };
                
                const response = await fetch(`${CONFIG.ML_API_URL}/ml/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const prediction = await response.json();
                console.log('üéØ Predi√ß√£o ML recebida:', prediction);
                
                lastMLPrediction = { ...prediction, direction: direction };
                
                // Mostrar predi√ß√£o
                displayMLPrediction(prediction, direction);
                
                // Se a predi√ß√£o for favor√°vel, executar o trade
                if (prediction.prediction === 'favor' && prediction.confidence > 0.6) {
                    await executeTrade(direction);
                } else if (prediction.prediction === 'avoid') {
                    showNotification(`üö´ ML recomenda evitar este trade (${(prediction.confidence*100).toFixed(1)}% confian√ßa)`, 'warning');
                } else {
                    showNotification(`‚öñÔ∏è ML neutro: ${(prediction.confidence*100).toFixed(1)}% confian√ßa - Trade manual`, 'warning');
                    await executeTrade(direction); // Executar mesmo assim no modo manual
                }
                
            } catch (error) {
                console.error('‚ùå Erro na predi√ß√£o ML:', error);
                showNotification(`Erro ML: ${error.message}`, 'error');
            }
        }

        function displayMLPrediction(prediction, direction) {
            const display = document.getElementById('mlPredictionDisplay');
            const content = document.getElementById('mlPredictionContent');
            
            const confidencePercent = (prediction.confidence * 100).toFixed(1);
            const winProbability = prediction.win_probability ? (prediction.win_probability * 100).toFixed(1) : 'N/A';
            
            let predictionIcon = '‚öñÔ∏è';
            let predictionColor = '#ffa726';
            
            if (prediction.prediction === 'favor') {
                predictionIcon = '‚úÖ';
                predictionColor = '#00ff88';
            } else if (prediction.prediction === 'avoid') {
                predictionIcon = 'üö´';
                predictionColor = '#ff4757';
            }
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: ${predictionColor};">${predictionIcon} ${prediction.prediction.toUpperCase()}</span>
                    <span style="font-weight: bold;">${direction}</span>
                </div>
                <div style="font-size: 0.9rem;">
                    <div>Confian√ßa: ${confidencePercent}%</div>
                    <div>Prob. Vit√≥ria: ${winProbability}%</div>
                    <div>Modelo: ${prediction.model_used}</div>
                    <div style="margin-top: 5px; opacity: 0.8;">${prediction.reason}</div>
                </div>
            `;
            
            display.classList.add('show');
            
            // Ocultar ap√≥s 15 segundos
            setTimeout(() => {
                display.classList.remove('show');
            }, 15000);
        }

        async function executeTrade(direction) {
            if (!derivWS || derivWS.readyState !== WebSocket.OPEN) {
                showNotification('Conex√£o Deriv n√£o est√° ativa', 'error');
                return;
            }

            const symbol = document.getElementById('symbolSelect').value;
            const stake = parseFloat(document.getElementById('stakeAmount').value);
            const duration = parseInt(document.getElementById('duration').value);

            const buyRequest = {
                buy: 1,
                price: stake,
                parameters: {
                    amount: stake,
                    basis: "stake",
                    contract_type: direction,
                    currency: accountInfo.currency || 'USD',
                    duration: duration,
                    duration_unit: 't',
                    symbol: symbol
                }
            };

            console.log('üõí Executando trade:', buyRequest);
            derivWS.send(JSON.stringify(buyRequest));
        }

        async function getMLAnalysis() {
            if (!isMLConnected) {
                showNotification('ML n√£o conectado', 'error');
                return;
            }

            try {
                const requestData = {
                    symbol: document.getElementById('symbolSelect').value,
                    current_price: currentPrice,
                    timestamp: new Date().toISOString(),
                    trades: trades.slice(-10),
                    balance: 1000, // Placeholder
                    win_rate: trades.length > 0 ? (trades.filter(t => t.outcome === 'won').length / trades.length) * 100 : 0,
                    volatility: Math.random() * 100,
                    market_condition: 'neutral',
                    martingale_level: 0,
                    is_after_loss: false,
                    ml_patterns: mlStats.patterns_count || 0,
                    ml_accuracy: mlStats.overall_win_rate || 0
                };
                
                const response = await fetch(`${CONFIG.ML_API_URL}/ml/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const analysis = await response.json();
                console.log('üìä An√°lise ML:', analysis);
                
                showNotification(
                    `üìä An√°lise ML: ${analysis.message} | Confian√ßa: ${analysis.confidence.toFixed(1)}%`,
                    'success'
                );
                
            } catch (error) {
                console.error('‚ùå Erro na an√°lise ML:', error);
                showNotification(`Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        async function forceMLTraining() {
            if (!isMLConnected) {
                showNotification('ML n√£o conectado', 'error');
                return;
            }

            try {
                document.getElementById('trainModelsBtn').disabled = true;
                showNotification('üéì Iniciando treinamento dos modelos ML...', 'warning');
                
                const response = await fetch(`${CONFIG.ML_API_URL}/ml/train`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üéì Treinamento iniciado:', result);
                
                showNotification('‚úÖ Treinamento ML iniciado em background!', 'success');
                
                // Recarregar stats ap√≥s 30 segundos
                setTimeout(loadMLStats, 30000);
                
            } catch (error) {
                console.error('‚ùå Erro no treinamento:', error);
                showNotification(`Erro no treinamento: ${error.message}`, 'error');
            } finally {
                document.getElementById('trainModelsBtn').disabled = false;
            }
        }

        async function loadMLStats() {
            if (!isMLConnected) return;

            try {
                const response = await fetch(`${CONFIG.ML_API_URL}/ml/stats`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const stats = await response.json();
                console.log('üìà Stats ML:', stats);
                
                mlStats = stats.ml_stats;
                
                // Atualizar indicadores
                document.getElementById('mlAccuracyDisplay').textContent = 
                    `${(mlStats.overall_win_rate * 100).toFixed(1)}%`;
                document.getElementById('mlPredictionsCount').textContent = 
                    stats.models_available.length;
                document.getElementById('mlPatternsCount').textContent = 
                    stats.patterns.patterns.length;
                document.getElementById('mlTradesCount').textContent = 
                    mlStats.total_trades;
                
                // Mostrar stats completas
                document.getElementById('mlRealStats').style.display = 'block';
                document.getElementById('mlRealStatsContent').innerHTML = `
                    <div><strong>Total de Trades:</strong> ${mlStats.total_trades}</div>
                    <div><strong>Total de Vit√≥rias:</strong> ${mlStats.total_wins}</div>
                    <div><strong>Taxa de Acerto:</strong> ${(mlStats.overall_win_rate * 100).toFixed(1)}%</div>
                    <div><strong>Modelos Carregados:</strong> ${mlStats.models_loaded}</div>
                    <div><strong>Padr√µes Identificados:</strong> ${stats.patterns.patterns.length}</div>
                    <div><strong>√öltimo Treino:</strong> ${mlStats.last_training ? 
                        `${mlStats.last_training.model_type} (${(mlStats.last_training.accuracy * 100).toFixed(1)}%)` : 
                        'Nunca'}</div>
                `;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar stats ML:', error);
            }
        }

        async function getMLStats() {
            await loadMLStats();
            showNotification('üìä Estat√≠sticas ML atualizadas!', 'success');
        }

        async function analyzeMLPatterns() {
            if (!isMLConnected) {
                showNotification('ML n√£o conectado', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.ML_API_URL}/ml/patterns`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const patterns = await response.json();
                console.log('üîç Padr√µes ML:', patterns);
                
                if (patterns.patterns.length > 0) {
                    const patternsList = patterns.patterns
                        .slice(0, 3)
                        .map(p => `${p.type}: ${p.description} (${(p.confidence * 100).toFixed(1)}%)`)
                        .join('\n');
                    
                    showNotification(`üîç Padr√µes encontrados:\n${patternsList}`, 'success');
                } else {
                    showNotification('üîç Nenhum padr√£o significativo encontrado ainda', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Erro na an√°lise de padr√µes:', error);
                showNotification(`Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        async function testMLConnection() {
            const url = document.getElementById('mlApiUrlConfig').value.trim();
            
            if (!url) {
                showNotification('Digite uma URL v√°lida', 'error');
                return;
            }

            try {
                document.getElementById('mlConnectionStatus').textContent = 'Testando...';
                
                const response = await fetch(`${url}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('mlConnectionStatus').innerHTML = 
                        `‚úÖ Conex√£o OK! Modelos: ${data.models_loaded}`;
                    CONFIG.ML_API_URL = url;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                document.getElementById('mlConnectionStatus').innerHTML = 
                    `‚ùå Erro: ${error.message}`;
            }
        }

        // ==============================================
        // FUN√á√ïES DE INTERFACE
        // ==============================================

        function enableMLControls(enabled) {
            const buttons = ['trainModelsBtn', 'mlStatsBtn', 'analyzePatternsBtn', 'callBtn', 'putBtn', 'analyzeBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = !enabled;
            });
        }

        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-dot ${status}`;
            }
        }

        function showDashboard() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateStatus('tradingStatus', 'online');
        }

        function setLoginLoading(loading) {
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginBtnText');
            const spinner = document.getElementById('loginSpinner');
            
            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'block';
            spinner.style.display = loading ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // ==============================================
        // INICIALIZA√á√ÉO
        // ==============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Trading Bot com ML Real inicializado');
            
            // Configurar eventos
            document.getElementById('apiToken').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    connectSystems();
                }
            });
            
            // Atualizar stats ML periodicamente se conectado
            setInterval(() => {
                if (isMLConnected) {
                    loadMLStats();
                }
            }, 60000); // A cada minuto
        });

        console.log('üß† TRADING BOT COM MACHINE LEARNING REAL');
        console.log('‚úÖ Features implementadas:');
        console.log('   üîó Conex√£o com API ML externa (FastAPI + Scikit-learn)');
        console.log('   üéØ Predi√ß√µes ML reais com m√∫ltiplos modelos');
        console.log('   üìä An√°lise de padr√µes baseada em dados hist√≥ricos');
        console.log('   üéì Treinamento autom√°tico de modelos');
        console.log('   üìà Estat√≠sticas e m√©tricas ML em tempo real');
        console.log('   üîç An√°lise de padr√µes de mercado');
        console.log('   ‚ö° Deploy na Render com backend Python');
    </script>
</body>
</html>